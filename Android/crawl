#!/bin/sh

CONF_FILE="crawl.config"

if ! test -e "$CONF_FILE"; then

  echo "ERROR: Configuration file '$CONF_FILE' not found."
  echo "Please create a configuration file with the following format:"
  echo "ADDRESS=<address to mirror>"
  echo "OUTPUT_DIR=<directory to save output>"
  echo "LOG_FILE=<file to save log>"
  echo ""
  echo "Example:"
  echo "ADDRESS=https://example.com"
  echo "OUTPUT_DIR=output"
  echo "LOG_FILE=mirror.log"
  echo ""
  echo "Then run the script again."
  echo ""
  exit 1
fi

# shellcheck disable=SC1090
. "$CONF_FILE"

if [ -z "$ADDRESS" ]; then

  echo "ERROR: ADDRESS is not set in '$CONF_FILE'."
  exit 1
fi

if [ -z "$OUTPUT_DIR" ]; then

  OUTPUT_DIR="output"
  echo "INFO: OUTPUT_DIR is not set in '$CONF_FILE'. Using default: $OUTPUT_DIR"
fi

if [ -z "$LOG_FILE" ]; then

  LOG_FILE="mirror.log"
  echo "INFO: LOG_FILE is not set in '$CONF_FILE'. Using default: $LOG_FILE"
fi

if  ! test -d "$OUTPUT_DIR"; then

  mkdir -p "$OUTPUT_DIR"
fi

echo "Starting/Resuming mirror of $ADDRESS"
echo "Output directory: $OUTPUT_DIR"
echo "Log file: $LOG_FILE"
echo "----------------------------------------"

wget \
    --mirror \
    --convert-links \
    --adjust-extension \
    --page-requisites \
    --no-parent \
    --reject=js,css \
    --continue \
    --timestamping \
    --no-clobber \
    --directory-prefix="$OUTPUT_DIR" \
    --append-output="$LOG_FILE" \
    --show-progress \
    --retry-on-http-error=503 \
    --waitretry=10 \
    --tries=20 \
    "$ADDRESS"

# shellcheck disable=SC2181
if [ $? -eq 0 ]; then

    echo "----------------------------------------"
    echo "Mirror completed successfully!"

else

    echo "----------------------------------------"
    echo "Mirror interrupted or encountered errors."
    echo "You can run this script again to continue from where it left off."
    echo "Check $LOG_FILE for details."
fi